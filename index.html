<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ã‡∏∑‡πâ‡∏≠ - V.Final Auto Save & Close</title> 
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'sarabun', sans-serif; background: #f0f0f0; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .input-panel { width: 35%; background: #2c3e50; color: white; padding: 20px; overflow-y: auto; box-shadow: 2px 0 5px rgba(0,0,0,0.1); box-sizing: border-box; position: relative; padding-bottom: 80px; }
        .input-panel h2 { margin-top: 0; color: #ecf0f1; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .search-box { background: #34495e; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #f39c12; }
        .search-row { display: flex; gap: 5px; }
        .btn-search { background: #f39c12; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-search:hover { background: #d35400; }
        .payment-update-box { background: #27ae60; padding: 15px; border-radius: 8px; margin-top: 10px; margin-bottom: 20px; border: 1px solid #2ecc71; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .payment-update-box h4 { margin: 0 0 10px 0; color: white; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 5px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 14px; color: #bdc3c7; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 8px; border: none; border-radius: 4px; font-family: 'Angsana', sans-serif; box-sizing: border-box; transition: box-shadow 0.2s; }
        .form-group input:focus, .form-group select:focus { outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.5); background: #ecf0f1; color: #2c3e50; }
        .section-header { background: #34495e; padding: 10px; margin: 20px -20px 15px; font-weight: bold; }
        .btn-group { margin-top: 20px; }
        .btn-master { border: none; padding: 15px; width: 100%; font-size: 18px; cursor: pointer; border-radius: 8px; font-weight: bold; color: white; background: #2980b9; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: all 0.3s ease; }
        .btn-master:hover { background: #1c5980; transform: translateY(-2px); box-shadow: 0 6px 8px rgba(0,0,0,0.3); }
        .btn-master:disabled { background: #95a5a6; cursor: not-allowed; transform: none; }
        .floating-tools { position: fixed; bottom: 20px; left: 20px; width: calc(35% - 60px); background: rgba(44, 62, 80, 0.95); padding: 10px; border-radius: 12px; display: flex; justify-content: space-around; align-items: center; gap: 5px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); border: 1px solid #4a6278; z-index: 1000; backdrop-filter: blur(5px); }
        .tool-btn { border: none; background: transparent; color: #bdc3c7; cursor: pointer; display: flex; flex-direction: column; align-items: center; font-size: 11px; transition: all 0.2s; padding: 8px 12px; border-radius: 8px; flex: 1; }
        .tool-btn i { font-size: 18px; margin-bottom: 4px; }
        .tool-btn:hover { color: white; background: rgba(255,255,255,0.1); transform: translateY(-2px); }
        .tool-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }
        .tool-btn.btn-mic { color: #ecf0f1; border: 1px solid rgba(255,255,255,0.1); }
        .tool-btn.btn-mic:hover { background: rgba(52, 152, 219, 0.2); color: #3498db; border-color: #3498db; }
        .tool-btn.btn-mic.listening { color: white; background: #e74c3c; border-color: #e74c3c; animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
        .preview-panel { flex: 1; padding: 40px; overflow-y: auto; display: flex; justify-content: center; background: #525659; box-sizing: border-box; }
        .legal-page { width: 100%; max-width: 215.9mm; min-height: 355.6mm; height: auto; background: white; padding: 5mm 5mm; box-shadow: 0 0 15px rgba(0,0,0,0.5); position: relative; box-sizing: border-box; color: #000; line-height: 1.6; font-size: 16px; }
        .doc-header { text-align: right; margin-bottom: 20px; }
        .doc-section-title { font-weight: bold; text-decoration: underline; margin-top: 15px; margin-bottom: 5px; font-size: 18px;}
        .doc-line { display: flex; flex-wrap: wrap; align-items: baseline; margin-bottom: 5px; column-gap: 5px; }
        .doc-label { white-space: nowrap; margin-right: 0px; }
        .fill-data { border-bottom: 1px solid #000; padding: 0 5px; color: #000000; font-weight: Regular; flex-grow: 1; min-width: 30px; text-align: center; }
        .fill-data.fixed-width { flex-grow: 0; min-width: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid black; padding: 4px; text-align: center; font-size: 14px; height: 25px; word-break: break-word; }
        th { background-color: #f2f2f2; }
        
        /* Auto Save Overlay */
        .auto-save-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 9999;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            color: white; font-size: 24px; text-align: center;
        }
        .spinner {
            border: 5px solid #f3f3f3; border-top: 5px solid #3498db;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media screen and (max-width: 768px) {
            body { flex-direction: column; height: auto; overflow: visible; }
            .input-panel { width: 100%; height: auto; overflow: visible; border-bottom: 5px solid #1a252f; padding-bottom: 20px; }
            .floating-tools { position: relative; bottom: auto; left: auto; width: 100%; margin-top: 20px; background: #34495e; }
            .preview-panel { width: 100%; padding: 10px; display: block; }
            .legal-page { padding: 10mm; font-size: 14px; }
        }
        @media print {
            body { background: white; display: block; height: auto; overflow: visible; }
            .input-panel, .floating-tools { display: none !important; }
            .preview-panel { padding: 0; display: block; background: white; margin: 0; }
            .legal-page { box-shadow: none; margin: 0; width: 215.9mm; max-width: none; height: auto; page-break-after: always; padding: 10mm; overflow: hidden; }
            @page { margin: 1cm; size: Legal; }
        }
    </style>
</head>
<body>

    <div id="autoSaveOverlay" class="auto-save-overlay">
        <div class="spinner"></div>
        <div id="autoSaveText">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...</div>
        <div style="font-size: 16px; margin-top: 10px; color: #ccc;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</div>
    </div>

    <div class="input-panel">
        <h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (Admin)</h2>
        
        <div class="search-box">
            <label style="color:#f39c12; font-weight:bold;">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏Å‡πà‡∏≤</label>
            <div class="search-row">
                <input type="text" id="searchInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." style="background: white; color: #333;">
                <button class="btn-search" onclick="searchContract()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            </div>
        </div>
		
		<div class="form-group">
            <label style="color:red">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ã‡∏•‡∏•‡πå (Sale Code)</label>
            <select id="inp_sale_code" data-map="sale_code" onchange="autoGenContractNo()">
                <option value="T">T (‡∏ó‡∏µ‡∏° T)</option>
                <option value="K">K (‡∏ó‡∏µ‡∏° K)</option>
                <option value="N">N (‡∏ó‡∏µ‡∏° N)</option>
            </select>
        </div>
        <div class="form-group"><label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤</label><input type="text" id="inp_c_no" data-map="c_no" oninput="update('c_no', this.value)" placeholder="‡πÄ‡∏ä‡πà‡∏ô 66/001"></div>
        <div class="form-group"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤</label><input type="date" id="inp_c_date" data-map="c_date" oninput="update('c_date', this.value)" onchange="update('c_date', this.value)"></div>

        <div class="form-group" style="background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 4px; border: 1px dashed #95a5a6; margin-top: 10px;">
            <label style="color: #4cd137; display: flex; align-items: center; gap: 5px;">
                <i class="fas fa-file-image"></i> ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
            </label>
            <input type="file" id="inp_contact_img" accept="image/*" onchange="handleContactImage(this)" style="color: white; font-size: 14px; margin-top:5px;">
            <div id="contact_img_status" style="font-size: 12px; color: #aaa; margin-top: 5px;">(‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤)</div>
        </div>

        <div class="section-header" style="background: #c0392b; display: flex; justify-content: space-between; align-items: center;">
            <span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (Admin Only)</span>
            <i class="fas fa-coins"></i>
        </div>
        <div class="form-group">
            <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ï‡πá‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤)</label> 
            <input type="text" id="inp_cost_price" data-map="product_cost" oninput="autoComma(this); calcTransfer();" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ï‡πá‡∏°..." style="border-left: 3px solid #c0392b;">
        </div>
        <div class="form-group">
    <label>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)</label>
    <input type="text" id="inp_shop_partner" list="shop_history_list" data-map="shop_name" 
           oninput="autoFillBankInfo()" 
           placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤..." 
           style="background: #fff; color: #333;">
    
    <datalist id="shop_history_list"></datalist>

    <div style="display: flex; gap: 5px; margin-top: 5px;">
        <select id="inp_shop_bank_name" onchange="updateBankDisplay()" style="width: 40%; font-size: 12px; background: #ecf0f1; color: #333;">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ --</option>
            <option value="‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ (KBANK)">‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ (KBANK)</option>
            <option value="‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå (SCB)">‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå (SCB)</option>
            <option value="‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û (BBL)">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û (BBL)</option>
            <option value="‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢ (KTB)">‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢ (KTB)</option>
            <option value="‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ (BAY)">‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ (BAY)</option>
            <option value="‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï (TTB)">‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï (TTB)</option>
            <option value="‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô (GSB)">‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô (GSB)</option>
            <option value="‡∏ò.‡∏Å.‡∏™. (BAAC)">‡∏ò.‡∏Å.‡∏™. (BAAC)</option>
            <option value="‡∏¢‡∏π‡πÇ‡∏≠‡∏ö‡∏µ (UOB)">‡∏¢‡∏π‡πÇ‡∏≠‡∏ö‡∏µ (UOB)</option>
            <option value="‡∏ã‡∏µ‡πÑ‡∏≠‡πÄ‡∏≠‡πá‡∏°‡∏ö‡∏µ (CIMB)">‡∏ã‡∏µ‡πÑ‡∏≠‡πÄ‡∏≠‡πá‡∏°‡∏ö‡∏µ (CIMB)</option>
            <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (GHB)">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (GHB)</option>
            <option value="‡πÅ‡∏•‡∏ô‡∏î‡πå ‡πÅ‡∏≠‡∏ô‡∏î‡πå ‡πÄ‡∏Æ‡πâ‡∏≤‡∏™‡πå (LH)">‡πÅ‡∏•‡∏ô‡∏î‡πå ‡πÅ‡∏≠‡∏ô‡∏î‡πå ‡πÄ‡∏Æ‡πâ‡∏≤‡∏™‡πå (LH)</option>
            <option value="‡∏ó‡∏¥‡∏™‡πÇ‡∏Å‡πâ (TISCO)">‡∏ó‡∏¥‡∏™‡πÇ‡∏Å‡πâ (TISCO)</option>
            <option value="‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ô‡∏≤‡∏Ñ‡∏¥‡∏ô‡∏†‡∏±‡∏ó‡∏£ (KKP)">‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ô‡∏≤‡∏Ñ‡∏¥‡∏ô‡∏†‡∏±‡∏ó‡∏£ (KKP)</option>
            <option value="‡πÑ‡∏≠‡∏ã‡∏µ‡∏ö‡∏µ‡∏ã‡∏µ (ICBC)">‡πÑ‡∏≠‡∏ã‡∏µ‡∏ö‡∏µ‡∏ã‡∏µ (ICBC)</option>
            <option value="‡πÑ‡∏ó‡∏¢‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï (TCR)">‡πÑ‡∏ó‡∏¢‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï (TCR)</option>
        </select>
        <input type="text" id="inp_shop_bank_acc" oninput="updateBankDisplay()" 
               placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ / ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" 
               style="width: 60%; font-size: 12px; color: #333; background: #fff;">
    </div>
</div>

<div class="form-group" style="background: rgba(192, 57, 43, 0.1); padding: 10px; border-radius: 4px; border: 1px solid #c0392b;">
    <label style="color: #c0392b; font-weight: bold;">üí∞ ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏£‡πâ‡∏≤‡∏ô</label>
    <input type="text" id="inp_transfer_shop" data-map="shop_transfer_amount" style="color: #c0392b; font-weight: bold; background: #fff;" readonly>
    <div id="shop_bank_display" style="font-size: 12px; color: #ecf0f1; margin-top: 5px; font-weight: bold;"></div>
</div>
        <div class="section-header">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠</div>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="inp_b_name" data-map="b_name" oninput="update('b_name', this.value)"></div>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label><input type="text" id="inp_b_nick" data-map="b_nick" oninput="update('b_nick', this.value)"></div>
        <div class="form-group"><label>‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label><input type="text" id="inp_b_age" data-map="b_age" oninput="update('b_age', this.value)"></div>
        <div class="form-group"><label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label><input type="text" id="inp_b_id_card" data-map="b_id_card" oninput="formatIdCard(this); update('b_id_card', this.value)" placeholder="1-2345-67891-23-4" maxlength="17"></div>
        <div class="form-group"><label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label><input type="text" id="inp_b_id_addr" data-map="b_id_addr" oninput="update('b_id_addr', this.value)"></div>
        <div class="form-group"><label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label><input type="text" id="inp_b_curr_addr" data-map="b_curr_addr" oninput="update('b_curr_addr', this.value)"></div>
        <div class="form-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ö‡πâ‡∏≤‡∏ô</label><input type="text" id="inp_b_tel" data-map="b_tel" oninput="formatPhone(this); update('b_tel', this.value)" maxlength="12"></div>
        <div class="form-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</label><input type="text" id="inp_b_mobile" data-map="b_mobile" oninput="formatPhone(this); update('b_mobile', this.value)" maxlength="12"></div>
        <div class="form-group"><label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label><input type="text" id="inp_b_work" data-map="b_work" oninput="update('b_work', this.value)"></div>
        <div class="form-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label><input type="text" id="inp_b_work_tel" data-map="b_work_tel" oninput="formatPhone(this); update('b_work_tel', this.value)" maxlength="12"></div>
        <div class="form-group"><label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label><input type="text" id="inp_b_work_addr" data-map="b_work_addr" oninput="update('b_work_addr', this.value)"></div>
        <div class="form-group"><label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á/‡πÅ‡∏ú‡∏ô‡∏Å</label><input type="text" id="inp_b_pos" data-map="b_pos" oninput="update('b_pos', this.value)"></div>
        <div class="form-group"><label>‡∏≠‡∏≤‡∏¢‡∏∏‡∏á‡∏≤‡∏ô (‡∏õ‡∏µ/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label><input type="text" id="inp_b_exp" data-map="b_exp" oninput="update('b_exp', this.value)"></div>

        <div class="section-header">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</div>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="inp_g_name" data-map="g_name" oninput="update('g_name', this.value)"></div>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label><input type="text" id="inp_g_nick" data-map="g_nick" oninput="update('g_nick', this.value)"></div>
        <div class="form-group"><label>‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label><input type="text" id="inp_g_age" data-map="g_age" oninput="update('g_age', this.value)"></div>
        <div class="form-group"><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</label><input type="text" id="inp_g_rel" data-map="g_rel" oninput="update('g_rel', this.value)"></div>
        <div class="form-group"><label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label><input type="text" id="inp_g_id_addr" data-map="g_id_addr" oninput="update('g_id_addr', this.value)"></div>
        <div class="form-group"><label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label><input type="text" id="inp_g_curr_addr" data-map="g_curr_addr" oninput="update('g_curr_addr', this.value)"></div>
        <div class="form-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ö‡πâ‡∏≤‡∏ô</label><input type="text" id="inp_g_tel" data-map="g_tel" oninput="formatPhone(this); update('g_tel', this.value)" maxlength="12"></div>
        <div class="form-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</label><input type="text" id="inp_g_mobile" data-map="g_mobile" oninput="formatPhone(this); update('g_mobile', this.value)" maxlength="12"></div>
        <div class="form-group"><label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label><input type="text" id="inp_g_work" data-map="g_work" oninput="update('g_work', this.value)"></div>
        <div class="form-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label><input type="text" id="inp_g_work_tel" data-map="g_work_tel" oninput="formatPhone(this); update('g_work_tel', this.value)" maxlength="12"></div>
        <div class="form-group"><label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label><input type="text" id="inp_g_work_addr" data-map="g_work_addr" oninput="update('g_work_addr', this.value)"></div>
        <div class="form-group"><label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á/‡πÅ‡∏ú‡∏ô‡∏Å</label><input type="text" id="inp_g_pos" data-map="g_pos" oninput="update('g_pos', this.value)"></div>
        <div class="form-group"><label>‡∏≠‡∏≤‡∏¢‡∏∏‡∏á‡∏≤‡∏ô (‡∏õ‡∏µ/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label><input type="text" id="inp_g_exp" data-map="g_exp" oninput="update('g_exp', this.value)"></div>

        <div class="section-header">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤</div>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="text" id="inp_p_name" data-map="p_name" oninput="update('p_name', this.value)"></div>
        <div class="form-group"><label>‡∏ä‡∏≥‡∏£‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤/‡∏î‡∏≤‡∏ß‡∏ô‡πå (‡∏ö‡∏≤‡∏ó)</label><input type="text" id="inp_p_down" data-map="p_down" oninput="autoComma(this); update('p_down', this.value); calcTransfer();"></div>
        <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label><input type="number" id="installments" data-map="p_install" oninput="update('p_install', this.value); generateTable()"></div>
        <div class="form-group"><label>‡∏á‡∏ß‡∏î‡∏•‡∏∞ (‡∏ö‡∏≤‡∏ó)</label><input type="text" id="amountPerMonth" data-map="p_amount" oninput="autoComma(this); update('p_amount', this.value); generateTable()"></div>
        <div class="form-group"><label>‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="text" id="inp_p_day" data-map="p_day" oninput="update('p_day', this.value); generateTable()"></div>
        <div class="form-group"><label>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏ß‡∏î‡πÅ‡∏£‡∏Å (‡∏ß/‡∏î/‡∏õ)</label><input type="date" id="startDate" data-map="p_first" oninput="update('p_first', this.value); generateTable()" onchange="update('p_first', this.value); generateTable()"></div>
        
        <div class="payment-update-box">
            <h4>üí∞ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h4>
            <div class="form-group"><label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</label><select id="pay_installment_no"><option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î‡∏Å‡πà‡∏≠‡∏ô --</option></select></div>
            <div class="form-group" style="background: rgba(0,0,0,0.1); padding:10px; border-radius:4px;"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞ (‡∏ö‡∏≤‡∏ó)</label><input type="text" id="pay_amount_val" oninput="autoComma(this)" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á..."></div>
            <div class="form-group"><label>‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</label><select id="pay_method_val"><option value="-">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -</option><option value="‡πÇ‡∏≠‡∏ô">üè¶ ‡πÇ‡∏≠‡∏ô</option><option value="‡πÇ‡∏≠‡∏ô‡∏£‡πâ‡∏≤‡∏ô">üè™ ‡πÇ‡∏≠‡∏ô‡∏£‡πâ‡∏≤‡∏ô</option><option value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option></select></div>
            <div class="form-group"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á</label><input type="date" id="pay_actual_date"></div>
            <div class="form-group"><label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</label><input type="text" id="pay_receipt_no" placeholder="‡πÄ‡∏ä‡πà‡∏ô RC-001"></div>
            <button class="btn-master" style="background:#27ae60; font-size:14px; padding:10px;" onclick="updatePaymentRecord()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏ß‡∏î‡∏ô‡∏µ‡πâ</button>
        </div>

        <div class="btn-group">
            <button class="btn-master" onclick="runAllActions()">
                <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á+Drive)
            </button>
            <div style="text-align: center; margin-top: 5px; font-size: 12px; color: #aaa;">(‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î JPG + ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Excel/JPG/PDF ‡∏Ç‡∏∂‡πâ‡∏ô Drive)</div>
        </div>
        
        <div class="floating-tools">
            <button class="tool-btn btn-mic" id="btnMic" onclick="toggleVoice()" title="‡∏û‡∏π‡∏î"><i class="fas fa-microphone"></i> ‡∏û‡∏π‡∏î</button>
            <div style="width:1px; height:30px; background:rgba(255,255,255,0.2); margin:0 5px;"></div>
            <button class="tool-btn btn-undo" onclick="undo()" id="btnUndo" title="‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö"><i class="fas fa-undo"></i> ‡∏¢‡πâ‡∏≠‡∏ô</button>
            <button class="tool-btn btn-redo" onclick="redo()" id="btnRedo" title="‡∏ó‡∏≥‡∏ã‡πâ‡∏≥"><i class="fas fa-redo"></i> ‡∏ã‡πâ‡∏≥</button>
            <button class="tool-btn btn-clear" onclick="clearForm()" title="‡∏•‡πâ‡∏≤‡∏á"><i class="fas fa-trash-alt"></i> ‡∏•‡πâ‡∏≤‡∏á</button>
        </div>
        <br><br><br>
    </div>

    <div class="preview-panel">
        <div class="legal-page" id="contractContent">
            <div class="doc-header">
                <div class="doc-line" style="justify-content: flex-end;"><span class="doc-label">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</span><span class="fill-data fixed-width" id="c_no" style="width: 150px;"></span></div>
                <div class="doc-line" style="justify-content: flex-end;"><span class="doc-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span><span class="fill-data fixed-width" id="c_date" style="width: 150px;"></span></div>
            </div>
            <div class="doc-section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠</div>
            <div class="doc-line">
                <span class="doc-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠</span><span class="fill-data" id="b_name"></span>
                <span class="doc-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</span><span class="fill-data fixed-width" id="b_nick" style="width: 80px;"></span>
                <span class="doc-label">‡∏≠‡∏≤‡∏¢‡∏∏</span><span class="fill-data fixed-width" id="b_age" style="width: 50px;"></span>
                <span class="doc-label">‡∏õ‡∏µ</span>
            </div>
            <div class="doc-line"><span class="doc-label">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</span><span class="fill-data" id="b_id_card"></span></div>
            <div class="doc-line"><span class="doc-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</span><span class="fill-data" id="b_id_addr"></span></div>
            <div class="doc-line"><span class="doc-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span><span class="fill-data" id="b_curr_addr"></span></div>
            <div class="doc-line"><span class="doc-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ö‡πâ‡∏≤‡∏ô</span><span class="fill-data" id="b_tel"></span><span class="doc-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</span><span class="fill-data" id="b_mobile"></span></div>
            <div class="doc-line"><span class="doc-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span><span class="fill-data" id="b_work"></span><span class="doc-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span><span class="fill-data" id="b_work_tel"></span></div>
            <div class="doc-line"><span class="doc-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span><span class="fill-data" id="b_work_addr"></span></div>
            <div class="doc-line"><span class="doc-label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á/‡πÅ‡∏ú‡∏ô‡∏Å</span><span class="fill-data" id="b_pos"></span><span class="doc-label">‡∏≠‡∏≤‡∏¢‡∏∏‡∏á‡∏≤‡∏ô</span><span class="fill-data fixed-width" id="b_exp" style="width: 120px;"></span></div>
            <div class="doc-section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ñ‡πâ‡∏≥</div>
            <div class="doc-line">
                <span class="doc-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ñ‡πâ‡∏≥</span><span class="fill-data" id="g_name"></span>
                <span class="doc-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</span><span class="fill-data fixed-width" id="g_nick" style="width: 80px;"></span>
                <span class="doc-label">‡∏≠‡∏≤‡∏¢‡∏∏</span><span class="fill-data fixed-width" id="g_age" style="width: 50px;"></span>
                <span class="doc-label">‡∏õ‡∏µ</span>
            </div>
            <div class="doc-line"><span class="doc-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</span><span class="fill-data" id="g_rel"></span><span class="doc-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</span><span class="fill-data" id="g_id_addr"></span></div>
            <div class="doc-line"><span class="doc-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span><span class="fill-data" id="g_curr_addr"></span></div>
            <div class="doc-line"><span class="doc-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ö‡πâ‡∏≤‡∏ô</span><span class="fill-data" id="g_tel"></span><span class="doc-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</span><span class="fill-data" id="g_mobile"></span></div>
            <div class="doc-line"><span class="doc-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span><span class="fill-data" id="g_work"></span><span class="doc-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span><span class="fill-data" id="g_work_tel"></span></div>
            <div class="doc-line"><span class="doc-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span><span class="fill-data" id="g_work_addr"></span></div>
            <div class="doc-line"><span class="doc-label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á/‡πÅ‡∏ú‡∏ô‡∏Å</span><span class="fill-data" id="g_pos"></span><span class="doc-label">‡∏≠‡∏≤‡∏¢‡∏∏‡∏á‡∏≤‡∏ô</span><span class="fill-data fixed-width" id="g_exp" style="width: 120px;"></span></div>
            <div class="doc-section-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤</div>
            <div class="doc-line">
                <span class="doc-label">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span><span class="fill-data" id="p_name"></span>
                <span class="doc-label">‡∏ä‡∏≥‡∏£‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤</span><span class="fill-data" id="p_down" style="width: 100px;"></span>
                <span class="doc-label">‡∏ö‡∏≤‡∏ó</span>
            </div>
            <div class="doc-line">
                <span class="doc-label">‡πÅ‡∏ö‡πà‡∏á‡∏ä‡∏≥‡∏£‡∏∞</span><span class="fill-data fixed-width" id="p_install" style="width: 50px;"></span>
                <span class="doc-label">‡∏á‡∏ß‡∏î‡∏•‡∏∞</span><span class="fill-data" id="p_amount"></span>
                <span class="doc-label">‡∏ö‡∏≤‡∏ó ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span><span class="fill-data fixed-width" id="p_day" style="width: 50px;"></span>
            </div>
            <div class="doc-line">
                <span class="doc-label">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏ß‡∏î‡πÅ‡∏£‡∏Å</span><span class="fill-data" id="p_first"></span>
                <span class="doc-label">‡∏á‡∏ß‡∏î‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</span><span class="fill-data" id="p_last"></span>
            </div>
            <div class="doc-section-title">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</div>
            <table id="paymentTable">
                <thead>
                    <tr>
                        <th style="width: 10%;">‡∏á‡∏ß‡∏î</th><th style="width: 15%;">‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ<br>(‡∏™‡∏±‡∏ç‡∏ç‡∏≤)</th>
                        <th style="width: 20%;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th><th style="width: 20%;">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞</th>
                        <th style="width: 15%;">‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ<br>(‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á)</th><th style="width: 20%;">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏£‡∏±‡∏ö</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏≥ URL ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw-CyPYltmiRAEq_g6LPkaJYydlEyNuDc9ronP0Fr5oqk4SPC8F-kBWzAhYCeLHLOdbTQ/exec';
        
        let paymentRecords = {};
        let contactImageBase64 = ""; 

        // Calculation
        function calcTransfer() {
            let fullPrice = parseFloat(document.getElementById('inp_cost_price').value.replace(/,/g,'')) || 0;
            let down = parseFloat(document.getElementById('inp_p_down').value.replace(/,/g,'')) || 0;
            let transfer = fullPrice - down;
            if (transfer < 0) transfer = 0;
            document.getElementById('inp_transfer_shop').value = transfer.toLocaleString();
        }

        function updateBankInfo() {
            let sel = document.getElementById('inp_shop_partner');
            let bank = sel.options[sel.selectedIndex].getAttribute('data-bank');
            document.getElementById('shop_bank_display').innerText = bank ? "üè¶ " + bank : "";
        }

        function autoGenContractNo() {
            const saleCode = document.getElementById('inp_sale_code').value;
            fetch(APPS_SCRIPT_URL + '?action=getNextContract&sale_code=' + saleCode)
            .then(r => r.json())
            .then(d => {
                if(d.status === 'success') {
                    document.getElementById('inp_c_no').value = d.nextContract;
                    update('c_no', d.nextContract);
                }
            })
            .catch(e => console.error("Auto Gen Error:", e));
        }

        function formatDateThai(dateStr) {
            if (!dateStr || dateStr === "-" || dateStr === "") return "";
            
            const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
            
            try {
                // ‡∏Å‡∏£‡∏ì‡∏µ 1: ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Date Picker (yyyy-mm-dd) ‡πÄ‡∏ä‡πà‡∏ô 2026-02-15
                if (typeof dateStr === 'string' && dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const parts = dateStr.split('-');
                    const y = parseInt(parts[0]);
                    const m = parseInt(parts[1]);
                    const d = parseInt(parts[2]);
                    const thaiYear = y < 2400 ? y + 543 : y; 
                    return `${d} ${months[m - 1]} ${thaiYear.toString().slice(-2)}`;
                }
                
                // ‡∏Å‡∏£‡∏ì‡∏µ 2: ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö‡∏°‡∏µ / ‡∏Ñ‡∏±‡πà‡∏ô (dd/mm/yyyy) ‡πÄ‡∏ä‡πà‡∏ô 15/02/2569 (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ô‡∏µ‡πâ)
                if (typeof dateStr === 'string' && dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                    const parts = dateStr.split('/');
                    const d = parseInt(parts[0]);
                    const m = parseInt(parts[1]);
                    const y = parseInt(parts[2]);
                    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏û.‡∏®. ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ.‡∏®.
                    const thaiYear = y < 2400 ? y + 543 : y;
                    return `${d} ${months[m - 1]} ${thaiYear.toString().slice(-2)}`;
                }

            } catch (e) { return dateStr; }
            
            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏ä‡πà‡∏ô 15 ‡∏Å.‡∏û. 69) ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
            return dateStr;
        }

        function formatIdCard(obj) {
            let val = obj.value.replace(/[^0-9]/g, '');
            if(val.length > 13) val = val.substring(0, 13);
            let result = '';
            if(val.length > 0) result += val.substr(0, 1);
            if(val.length > 1) result += '-' + val.substr(1, 4);
            if(val.length > 5) result += '-' + val.substr(5, 5);
            if(val.length > 10) result += '-' + val.substr(10, 2);
            if(val.length > 12) result += '-' + val.substr(12, 1);
            obj.value = result;
        }

        function formatPhone(obj) {
            let raw = obj.value.replace(/[^0-9]/g, ''); 
            let isMobileField = obj.id.includes('mobile'); 
            let formatted = raw;
            if (raw.length > 10) raw = raw.substring(0, 10);
            if (raw.length > 6) formatted = raw.slice(0,3) + '-' + raw.slice(3,6) + '-' + raw.slice(6);
            else if (raw.length > 3) formatted = raw.slice(0,3) + '-' + raw.slice(3);
            obj.value = formatted;
        }

        let historyStack = []; let historyIndex = -1; let isRestoring = false; let saveTimeout;
        function saveState(force = false) {
            if (isRestoring) return;
            clearTimeout(saveTimeout);
            const performSave = () => {
                const inputs = document.querySelectorAll('.input-panel input:not(.search-box input), .input-panel select');
                const currentState = [];
                inputs.forEach(input => currentState.push(input.value));
                if (historyIndex < historyStack.length - 1) historyStack = historyStack.slice(0, historyIndex + 1);
                historyStack.push(currentState);
                historyIndex++;
                updateButtonStates();
            };
            if (force) performSave(); else saveTimeout = setTimeout(performSave, 500);
        }

        function restoreState(index) {
            if (index < 0 || index >= historyStack.length) return;
            isRestoring = true;
            const state = historyStack[index];
            const inputs = document.querySelectorAll('.input-panel input:not(.search-box input), .input-panel select');
            inputs.forEach((input, i) => {
                if(state[i] !== undefined) {
                    input.value = state[i];
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
            historyIndex = index;
            updateButtonStates();
            setTimeout(() => { isRestoring = false; }, 100);
        }
        function undo() { if (historyIndex > 0) restoreState(historyIndex - 1); }
        function redo() { if (historyIndex < historyStack.length - 1) restoreState(historyIndex + 1); }
        function clearForm() {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                isRestoring = true;
                document.querySelectorAll('.input-panel input:not(.search-box input)').forEach(input => { input.value = ""; input.dispatchEvent(new Event('input')); });
                paymentRecords = {};
                generateTable();
                isRestoring = false;
                saveState(true);
            }
        }
        function updateButtonStates() {
            document.getElementById('btnUndo').disabled = (historyIndex <= 0);
            document.getElementById('btnRedo').disabled = (historyIndex >= historyStack.length - 1);
        }

        function handleContactImage(input) {
            const statusDiv = document.getElementById('contact_img_status');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    contactImageBase64 = e.target.result;
                    statusDiv.innerText = "‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î: " + input.files[0].name;
                    statusDiv.style.color = "#2ecc71";
                };
                reader.readAsDataURL(input.files[0]);
            } else { contactImageBase64 = ""; }
        }

        let recognition; let activeInput = null; 
        function initVoiceSystem() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) { document.getElementById('btnMic').style.display = 'none'; return; }
            recognition = new SpeechRecognition();
            recognition.lang = 'th-TH';
            recognition.onresult = function(event) {
                if (activeInput) {
                    const transcript = event.results[0][0].transcript;
                    activeInput.value = (activeInput.value && activeInput.value.trim() !== "") ? activeInput.value + " " + transcript : transcript;
                    activeInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            };
            const inputs = document.querySelectorAll('.input-panel input');
            inputs.forEach(input => { input.addEventListener('focus', () => { activeInput = input; }); input.addEventListener('input', () => saveState()); });
        }
        function toggleVoice() {
            const btnMic = document.getElementById('btnMic');
            if (btnMic.classList.contains('listening')) recognition.stop();
            else { if(!activeInput) { alert("‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö"); return; } recognition.start(); }
        }

        function applySmartFormatting(id, value) {
            let formatted = value;
            if (id === 'b_exp' || id === 'g_exp') {
                let cleanVal = formatted.replace(/[^\d\/\.\-\s]/g, '').trim();
                let parts = cleanVal.split(/[\/\.\-\s]+/);
                if (parts.length > 0 && parts[0] !== "") {
                    let yearVal = parseInt(parts[0]);
                    let monthVal = (parts.length > 1 && parts[1] !== "") ? parts[1] : "";
                    formatted = (yearVal > 0 ? yearVal + " ‡∏õ‡∏µ" : "") + (monthVal !== "" ? " " + monthVal + " ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" : "");
                }
            }
            if (['b_id_addr', 'b_curr_addr', 'b_work_addr', 'g_id_addr', 'g_curr_addr', 'g_work_addr'].includes(id)) {
                formatted = formatted.replace(/\s*‡∏ï‡∏≥‡∏ö‡∏•\s*/g, " ‡∏ï.").replace(/\s*‡∏≠‡∏≥‡πÄ‡∏†‡∏≠\s*/g, "  ‡∏≠.").replace(/\s*‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î\s*/g, "  ‡∏à.").trim();
            }
            return formatted;
        }

        function autoComma(obj) {
            var value = obj.value.replace(/,/g, '');
            if (!isNaN(value) && value !== "") {
                var parts = value.split('.');
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                obj.value = parts.join('.');
            }
        }

        function update(id, value) {
            let finalValue = applySmartFormatting(id, value);
            if (id === 'c_date' || id === 'p_first' || id.includes('date')) {
                document.getElementById(id).innerText = formatDateThai(value);
            } else {
                if (!finalValue || finalValue.trim() === "") finalValue = "-";
                document.getElementById(id).innerText = finalValue;
            }
        }
        
        function updatePaymentRecord() {
            const installNo = document.getElementById('pay_installment_no').value;
            const actDate = document.getElementById('pay_actual_date').value;
            const recNo = document.getElementById('pay_receipt_no').value;
            const payAmount = document.getElementById('pay_amount_val').value;
            const payMethod = document.getElementById('pay_method_val').value;
            if(!installNo) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏ß‡∏î"); return; }
            paymentRecords[installNo] = { actualDate: actDate ? formatDateThai(actDate) : "", rawDate: actDate, receiptNo: recNo, paidAmount: payAmount, payMethod: payMethod };
            generateTable(); alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà ${installNo} ‡πÅ‡∏•‡πâ‡∏ß`);
        }

        function generateTable() {
            const inputInstallments = parseInt(document.getElementById('installments').value) || 0;
            const fixedRows = 12; 
            let startDateVal = document.getElementById('startDate').value;
            const tbody = document.querySelector("#paymentTable tbody");
            const select = document.getElementById("pay_installment_no");
            tbody.innerHTML = "";
            let currentSelect = select.value;
            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏ß‡∏î --</option>';
            const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
            for (let i = 0; i < fixedRows; i++) {
                let dateStr = "", actDateStr = "", receiptStr = "", paidAmountStr = "", methodStr = "";
                let instNum = i + 1;
                if (i < inputInstallments) {
                    if(startDateVal) {
                        const parts = startDateVal.split('-');
                        const startObj = new Date(parts[0], parts[1] - 1, parts[2]);
                        let targetDate;
                        if (i === 0) targetDate = startObj;
                        else {
                            let payDayVal = parseInt(document.getElementById('inp_p_day').value);
                            let preferredDay = (payDayVal && payDayVal > 0 && payDayVal <= 31) ? payDayVal : startObj.getDate();
                            targetDate = new Date(startObj.getFullYear(), startObj.getMonth() + i, preferredDay);
                        }
                        const y = (targetDate.getFullYear() + 543).toString().slice(-2);
                        dateStr = `${targetDate.getDate()} ${months[targetDate.getMonth()]} ${y}`;
                    }
                    let opt = document.createElement("option");
                    opt.value = instNum; opt.text = `‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà ${instNum} (${dateStr})`; select.appendChild(opt);
                    if(paymentRecords[instNum]) {
                        // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ formatDateThai ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
                        actDateStr = formatDateThai(paymentRecords[instNum].actualDate || "");
                        receiptStr = paymentRecords[instNum].receiptNo || "";
                        paidAmountStr = paymentRecords[instNum].paidAmount || "";
                        methodStr = paymentRecords[instNum].payMethod || "";
                    }
                    if (i === inputInstallments - 1) document.getElementById('p_last').innerText = dateStr;
                }
                tbody.innerHTML += `<tr><td>${i < inputInstallments ? instNum : instNum}</td><td>${dateStr}</td><td>${i < inputInstallments ? paidAmountStr : ""}</td><td>${methodStr}</td><td style="color:red;">${actDateStr}</td><td style="color:red; font-weight:bold;">${receiptStr}</td></tr>`;
            }
            if(select.querySelector(`option[value='${currentSelect}']`)) select.value = currentSelect;
        }

        // --- üü¢ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏≠) ---
        function searchContract(directCNo = null) {
            const searchNo = directCNo || document.getElementById('searchInput').value.trim();
            if(!searchNo) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤"); return Promise.reject("No Input"); }
            
            const btn = document.querySelector('.btn-search');
            if(btn) { btn.innerText = "‚è≥.."; btn.disabled = true; }

            return fetch(APPS_SCRIPT_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: 'search', contract_no: searchNo }) 
            })
            .then(response => response.json())
            .then(result => {
                if(result.status === 'success') {
                    const data = result.data;
                    for (const key in data) {
                        const input = document.querySelector(`[data-map="${key}"]`);
                        if(input) { 
                            input.value = data[key]; 
                            input.dispatchEvent(new Event(input.type === 'date' ? 'change' : 'input')); 
                        }
                    }

                    const cNoVal = document.getElementById('inp_c_no').value;
                    if (cNoVal) {
                        const prefix = cNoVal.split('-')[0].trim().toUpperCase(); 
                        const saleSelect = document.getElementById('inp_sale_code');
                        if (prefix === 'T' || prefix === 'K' || prefix === 'N') {
                            saleSelect.value = prefix;
                        }
                    }

                    if(data.payment_records_json) { try { paymentRecords = JSON.parse(data.payment_records_json); } catch(e) {} } 
                    generateTable(); 
                    
                    if(!directCNo) alert("‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ç‡∏ç‡∏≤: " + data.b_name);
                    return true; // ‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ß‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                } else { 
                    if(!directCNo) alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ô‡∏µ‡πâ"); 
                    return false; // ‚ùå ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö
                }
            })
            .catch(e => { 
                if(!directCNo) alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + e.message); 
                return false;
            }) 
            .finally(() => { 
                if(btn) { btn.innerText = "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"; btn.disabled = false; } 
            });
        }

        // üü¢ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà (V.Final with Auto Save & Close)
        async function runAllActions(isAuto = false) {
    const btn = document.querySelector('.btn-group .btn-master');
    if(btn) { btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£..."; btn.disabled = true; }
    
    // ‡πÅ‡∏™‡∏î‡∏á Overlay ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Auto
    if(isAuto) {
        document.getElementById('autoSaveOverlay').style.display = 'flex';
        document.getElementById('autoSaveText').innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏±‡∏ç‡∏ç‡∏≤...";
    }

    try {
        let bName = document.getElementById('inp_shop_bank_name').value;
        let bAcc = document.getElementById('inp_shop_bank_acc').value;
        
        if(!document.getElementById('hidden_bank_combine')) {
            let h = document.createElement('input'); 
            h.type='hidden'; h.id='hidden_bank_combine'; h.setAttribute('data-map', 'shop_bank_detail'); 
            document.body.appendChild(h);
        }
        document.getElementById('hidden_bank_combine').value = `${bName} ${bAcc}`.trim();
        saveNewShopToHistory();
				console.log("Step 1: Starting Save Process...");
                let formData = { action: 'save', payment_records_json: JSON.stringify(paymentRecords) };
                document.querySelectorAll('[data-map]').forEach(el => { formData[el.getAttribute('data-map')] = el.value; });
                formData.file_name_base = `‡∏™‡∏±‡∏ç‡∏ç‡∏≤_${formData.c_no || 'Draft'}_${formData.b_name || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'}`.replace(/[\/\s]/g, "-");
                if (contactImageBase64) formData.contact_image_base64 = contactImageBase64;
                
                if (!formData.c_no) { throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡∏£‡∏∞‡∏ö‡∏ö Gen ‡πÄ‡∏•‡∏Ç)"); }

                // 1. Generate Excel
                var wb = XLSX.utils.book_new(); 
                let contractData = [["‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠", "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"]];
                for(let key in formData) {
                     if(typeof formData[key] === 'string' && formData[key].length < 500 && !key.includes('base64')) {
                         let val = formData[key];
                         if (key === 'c_date' || key === 'p_first') val = formatDateThai(val);
                         contractData.push([key, val]);
                     }
                }
                var ws1 = XLSX.utils.aoa_to_sheet(contractData);
                XLSX.utils.book_append_sheet(wb, ws1, "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ç‡∏ç‡∏≤");
                const excelBase64 = XLSX.write(wb, {bookType:'xlsx', type:'base64'});
                formData.excel_base64 = excelBase64;

                // 2. Generate Image (html2canvas)
                try {
                    const element = document.getElementById('contractContent');
                    
    const canvas = await html2canvas(element, { 
        scale: 2,                
        backgroundColor: "#ffffff", 
        useCORS: true,           
        windowWidth: 1600,       
        x: 0, y: 0, scrollY: 0,              

        onclone: (clonedDoc) => {
            const clonedHtml = clonedDoc.documentElement;
            const clonedBody = clonedDoc.body;
            const clonedEl = clonedDoc.getElementById('contractContent');

            // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö Container ‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡∏´‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
            clonedHtml.style.height = 'auto';
            clonedBody.style.height = 'auto';
            clonedBody.style.width = '1600px';
            clonedBody.style.minHeight = 'auto';
            clonedBody.style.overflow = 'visible'; 
            clonedBody.style.margin = '0'; // ‡∏•‡∏ö‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏≤‡∏ß‡∏£‡∏≠‡∏ö‡∏ô‡∏≠‡∏Å
            clonedBody.style.padding = '0';

            if(clonedEl) {
                clonedEl.style.width = '215.9mm';  
                clonedEl.style.minHeight = 'auto'; 
                clonedEl.style.height = 'max-content'; // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏à‡∏£‡∏¥‡∏á
                clonedEl.style.boxShadow = 'none'; // ‡∏•‡∏ö‡πÄ‡∏á‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡∏Ñ‡∏•‡∏µ‡∏ô
                clonedEl.style.margin = '0 auto';  // ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á
            }
        }
    });
                    
                    const imageBase64 = canvas.toDataURL('image/jpeg', 0.9);
                    formData.image_base64 = imageBase64;

                    // 3. Generate PDF
                    const { jsPDF } = window.jspdf || window;
                    if(jsPDF) {
                        const doc = new jsPDF('p', 'mm', 'legal');
                        const imgProps = doc.getImageProperties(imageBase64);
                        doc.addImage(imageBase64, 'JPEG', 0, 0, doc.internal.pageSize.getWidth(), (imgProps.height * doc.internal.pageSize.getWidth()) / imgProps.width);
                        formData.pdf_base64 = doc.output('datauristring').split(',')[1];
                    }
                } catch(imgErr) {
                    console.error("Image Gen Error:", imgErr);
                }

                console.log("Step 2: Sending Data to Script...");
                await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify(formData) });
                
                if(!isAuto) { 
                    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); 
                } else {
                    document.getElementById('autoSaveText').innerText = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î...";
                    setTimeout(() => {
                        window.opener && window.opener.focus();
                        window.close();
                    }, 1000);
                }

            } catch (error) { 
                console.error(error);
                if(!isAuto) {
                    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message); 
                } else {
                    document.getElementById('autoSaveOverlay').style.display = 'none';
                    alert("‚ùå Auto Save Failed: " + error.message);
                }
            } 
            finally { 
                if(btn) { 
                    btn.innerHTML = '<i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á+Drive)'; 
                    btn.disabled = false; 
                } 
            }
        }

function loadShopHistory() {
    let shops = JSON.parse(localStorage.getItem('contract_shop_history')) || [];
    if (shops.length === 0) {
        shops = [{ name: "‡∏£‡πâ‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á", bankName: "‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ (KBANK)", bankAcc: "123-4-56789-0" }];
        localStorage.setItem('contract_shop_history', JSON.stringify(shops));
    }
    const dataList = document.getElementById('shop_history_list');
    dataList.innerHTML = '';
    shops.forEach(shop => {
        let option = document.createElement('option');
        option.value = shop.name;
        dataList.appendChild(option);
    });
}

function autoFillBankInfo() {
    let name = document.getElementById('inp_shop_partner').value;
    let shops = JSON.parse(localStorage.getItem('contract_shop_history')) || [];
    let found = shops.find(s => s.name === name);
    if (found) {
        if (found.bankName) {
            document.getElementById('inp_shop_bank_name').value = found.bankName;
            document.getElementById('inp_shop_bank_acc').value = found.bankAcc;
        } else if (found.bank) {
            document.getElementById('inp_shop_bank_name').value = ""; 
            document.getElementById('inp_shop_bank_acc').value = found.bank;
        }
    } else {
        document.getElementById('inp_shop_bank_name').value = "";
        document.getElementById('inp_shop_bank_acc').value = ""; 
    }
    updateBankDisplay();
}

function updateBankDisplay() {
    let bankName = document.getElementById('inp_shop_bank_name').value;
    let bankAcc = document.getElementById('inp_shop_bank_acc').value;
    let displayDiv = document.getElementById('shop_bank_display');
    
    if (bankName || bankAcc) {
        displayDiv.innerText = `üè¶ ‡πÇ‡∏≠‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà: ${bankName} ${bankAcc}`;
        displayDiv.style.color = "#f1c40f"; 
    } else {
        displayDiv.innerText = "";
    }
}

function saveNewShopToHistory() {
    let name = document.getElementById('inp_shop_partner').value.trim();
    let bankName = document.getElementById('inp_shop_bank_name').value;
    let bankAcc = document.getElementById('inp_shop_bank_acc').value.trim();
    if (!name) return;
    let shops = JSON.parse(localStorage.getItem('contract_shop_history')) || [];
    let existingIndex = shops.findIndex(s => s.name === name);
    let newEntry = { name: name, bankName: bankName, bankAcc: bankAcc };
    if (existingIndex >= 0) { shops[existingIndex] = newEntry; } else { shops.push(newEntry); }
    localStorage.setItem('contract_shop_history', JSON.stringify(shops));
    loadShopHistory();
}

        window.onload = function() {
            loadShopHistory();
			generateTable(); initVoiceSystem();
            document.querySelectorAll('.fill-data').forEach(field => { if (!field.innerText) field.innerText = "-"; });
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL Parameter ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Auto Update
            const urlParams = new URLSearchParams(window.location.search);
            const refCNo = urlParams.get('c_no');
            const isAutoUpdate = urlParams.get('auto_update') === 'true';

            if (refCNo) {
                // ‡πÅ‡∏™‡∏î‡∏á Overlay ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Auto
                if (isAutoUpdate) {
                    document.getElementById('autoSaveOverlay').style.display = 'flex';
                    document.getElementById('autoSaveText').innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
                }

                document.getElementById('searchInput').value = refCNo;
                document.getElementById('inp_c_no').value = refCNo;
                
                // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô
                searchContract(refCNo).then((success) => {
                    if (success && isAutoUpdate) {
                        document.getElementById('autoSaveText').innerText = "‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
                        // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ DOM Render ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
                        setTimeout(() => { runAllActions(true); }, 2000);
                    } else if (!success && isAutoUpdate) {
                        document.getElementById('autoSaveOverlay').style.display = 'none';
                        alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ");
                    }
                });
            } else {
                autoGenContractNo();
            }
            saveState(true);
        };
    </script>
</body>
</html>